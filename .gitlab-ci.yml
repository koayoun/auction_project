# ============================================
# GitLab CI/CD - CI Only (Build & Push to Harbor)
# CDëŠ” ArgoCDë¡œ ë³„ë„ ì²˜ë¦¬
# ============================================

# ì „ì—­ ë³€ìˆ˜ ì„¤ì •
variables:
  # BuildKit í™œì„±í™” ë° ì„¤ì •
  DOCKER_BUILDKIT: "1"
  BUILDKIT_PROGRESS: "plain"
  BUILDKIT_INLINE_CACHE: "1"
  
  # Docker í˜¸ìŠ¤íŠ¸ ì„¤ì • (DinD ì„œë¹„ìŠ¤ì™€ í†µì‹ )
  DOCKER_HOST: tcp://localhost:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  
  # Harbor ì´ë¯¸ì§€ ê²½ë¡œ (Variablesì—ì„œ ê°€ì ¸ì˜´)
  IMAGE_NAME: "${HARBOR_URL}/${HARBOR_PROJECT}/${CI_PROJECT_NAME}"

# íŒŒì´í”„ë¼ì¸ ë‹¨ê³„
stages:
  - build
  - update-manifest

# ============================================
# Build ë‹¨ê³„ - BuildKit ìµœì í™”
# ============================================
build-image:
  stage: build
  image: docker:24-dind
  services:
    - name: docker:24-dind
      command:
        - --tls=false
        - --mtu=1450
  before_script:
    - echo "ğŸ” Harborì— ë¡œê·¸ì¸ ì¤‘..."
    - echo "$HARBOR_PASSWORD" | docker login $HARBOR_URL -u $HARBOR_USERNAME --password-stdin
    - echo "âœ… Harbor ë¡œê·¸ì¸ ì„±ê³µ"
    - docker info
    - docker buildx version || echo "âš ï¸ buildx not available, using legacy BuildKit"
    - "docker info | grep BuildKit || echo 'BuildKit: enabled via DOCKER_BUILDKIT=1'"
    
  script:
    - echo "ğŸ”¨ BuildKitìœ¼ë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
    
    # ìºì‹œ pull (ë¹Œë“œ ì†ë„ í–¥ìƒ)
    - docker pull ${IMAGE_NAME}:latest || true
    
    # BuildKit ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ
    - |
      docker build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg CI_COMMIT_SHA=${CI_COMMIT_SHA} \
        --build-arg CI_COMMIT_SHORT_SHA=${CI_COMMIT_SHORT_SHA} \
        --cache-from ${IMAGE_NAME}:latest \
        --tag ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} \
        --tag ${IMAGE_NAME}:latest \
        --file Dockerfile \
        --progress=plain \
        .
    
    - echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
    - docker images | grep ${CI_PROJECT_NAME}
    
    - echo "ğŸ“¤ Harborë¡œ ì´ë¯¸ì§€ Push ì¤‘..."
    - docker push ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - docker push ${IMAGE_NAME}:latest
    - echo "âœ… ì´ë¯¸ì§€ Push ì™„ë£Œ!"
    - "echo 'ğŸ“¦ ìµœì¢… ì´ë¯¸ì§€: ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}'"
    
  after_script:
    - docker logout $HARBOR_URL || true
    - docker image prune -f || true
    
  tags:
    - k8s-runner  # ë˜ëŠ” ë‹¹ì‹ ì˜ runner tag
    
  only:
    - master
    - main
    
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ============================================
# MR ì „ìš© ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ëª©ì , Push ì•ˆí•¨)
# ============================================
build-image-mr:
  stage: build
  image: docker:24-dind
  services:
    - name: docker:24-dind
      command: ["--tls=false", "--mtu=1450"]
      
  before_script:
    - echo "ğŸ” Harborì— ë¡œê·¸ì¸ ì¤‘..."
    - echo "$HARBOR_PASSWORD" | docker login $HARBOR_URL -u $HARBOR_USERNAME --password-stdin
    - docker pull ${IMAGE_NAME}:latest || true
    
  script:
    - echo "ğŸ”¨ MRìš© ì´ë¯¸ì§€ ë¹Œë“œ (Push ì œì™¸)..."
    - |
      docker build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from ${IMAGE_NAME}:latest \
        --tag ${IMAGE_NAME}:mr-${CI_MERGE_REQUEST_IID} \
        --file Dockerfile \
        --progress=plain \
        .
    - echo "âœ… MR ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ (Harbor Push ì•ˆ í•¨)"
    
  after_script:
    - docker logout $HARBOR_URL || true
    
  tags:
    - k8s-runner
    
  only:
    - merge_requests
    
  except:
    - master
    - main

# ============================================
# Update Manifest Stage - K8s YAML ìë™ ì—…ë°ì´íŠ¸
# ============================================
update-manifest:
  stage: update-manifest
  image: alpine/git
  
  before_script:
    # yq ì„¤ì¹˜ (YAML íŒŒì„œ)
    - apk add --no-cache curl
    - curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/bin/yq
    - chmod +x /usr/bin/yq
    
    # Git ì„¤ì •
    - git config --global user.email "gitlab-ci@bdc105.kro.kr"
    - git config --global user.name "GitLab CI Bot"
  
  script:
    - echo "ğŸ“ K8s Manifest ì—…ë°ì´íŠ¸ ì¤‘..."
    
    # í˜„ì¬ ë¸Œëœì¹˜ ìµœì‹  ìƒíƒœë¡œ pull
    - git pull origin ${CI_COMMIT_REF_NAME} || true
    
    # k8s/deployment.yamlì˜ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
    - |
      yq eval ".spec.template.spec.containers[0].image = \"${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}\"" \
        -i k8s/deployment.yaml
    
    # ë³€ê²½ì‚¬í•­ í™•ì¸
    - echo "ğŸ“„ ë³€ê²½ëœ ë‚´ìš©:"
    - git diff k8s/deployment.yaml
    
    # Git commit & push
    - git add k8s/deployment.yaml
    - |
      if git diff --staged --quiet; then
        echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
      else
        git commit -m "chore: update image to ${CI_COMMIT_SHORT_SHA} [skip ci]"
        git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
        echo "âœ… Manifest ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        echo "ğŸ”„ ArgoCDê°€ ìë™ìœ¼ë¡œ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤ (ìµœëŒ€ 3ë¶„ ì†Œìš”)"
      fi
  
  tags:
    - k8s-runner
  
  only:
    - master
    - main
  
  needs:
    - build-image