# ============================================
# GitLab CI/CD - CI Only (Build & Push to Harbor)
# CDëŠ” ArgoCDë¡œ ë³„ë„ ì²˜ë¦¬
# ============================================

# ì „ì—­ ë³€ìˆ˜ ì„¤ì •
variables:
  # BuildKit í™œì„±í™” ë° ì„¤ì •
  DOCKER_BUILDKIT: "1"
  BUILDKIT_PROGRESS: "plain"
  BUILDKIT_INLINE_CACHE: "1"
  
  # Docker í˜¸ìŠ¤íŠ¸ ì„¤ì • (DinD ì„œë¹„ìŠ¤ì™€ í†µì‹ )
  DOCKER_HOST: tcp://localhost:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  
  # Harbor ì´ë¯¸ì§€ ê²½ë¡œ (Variablesì—ì„œ ê°€ì ¸ì˜´)
  IMAGE_NAME: "${HARBOR_URL}/${HARBOR_PROJECT}/${CI_PROJECT_NAME}"

# íŒŒì´í”„ë¼ì¸ ë‹¨ê³„
stages:
  - build

# ============================================
# Build ë‹¨ê³„ - BuildKit ìµœì í™”
# ============================================
build-image:
  stage: build
  image: docker:24-dind
  services:
    - name: docker:24-dind
      command:
        - --tls=false
        - --mtu=1450
  before_script:
    - echo "ğŸ” Harborì— ë¡œê·¸ì¸ ì¤‘..."
    - echo "$HARBOR_PASSWORD" | docker login $HARBOR_URL -u $HARBOR_USERNAME --password-stdin
    - echo "âœ… Harbor ë¡œê·¸ì¸ ì„±ê³µ"
    - docker info
    - docker buildx version || echo "âš ï¸ buildx not available, using legacy BuildKit"
    - "docker info | grep BuildKit || echo 'BuildKit: enabled via DOCKER_BUILDKIT=1'"
    
  script:
    - echo "ğŸ”¨ BuildKitìœ¼ë¡œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
    
    # ìºì‹œ pull (ë¹Œë“œ ì†ë„ í–¥ìƒ)
    - docker pull ${IMAGE_NAME}:latest || true
    
    # BuildKit ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ
    - |
      docker build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg CI_COMMIT_SHA=${CI_COMMIT_SHA} \
        --build-arg CI_COMMIT_SHORT_SHA=${CI_COMMIT_SHORT_SHA} \
        --cache-from ${IMAGE_NAME}:latest \
        --tag ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} \
        --tag ${IMAGE_NAME}:latest \
        --file Dockerfile \
        --progress=plain \
        .
    
    - echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
    - docker images | grep ${CI_PROJECT_NAME}
    
    - echo "ğŸ“¤ Harborë¡œ ì´ë¯¸ì§€ Push ì¤‘..."
    - docker push ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - docker push ${IMAGE_NAME}:latest
    - echo "âœ… ì´ë¯¸ì§€ Push ì™„ë£Œ!"
    - "echo 'ğŸ“¦ ìµœì¢… ì´ë¯¸ì§€: ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}'"
    
  after_script:
    - docker logout $HARBOR_URL || true
    - docker image prune -f || true
    
  tags:
    - k8s-runner  # ë˜ëŠ” ë‹¹ì‹ ì˜ runner tag
    
  only:
    - master
    - main
    
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ============================================
# MR ì „ìš© ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ëª©ì , Push ì•ˆí•¨)
# ============================================
build-image-mr:
  stage: build
  image: docker:24-dind
  services:
    - name: docker:24-dind
      command: ["--tls=false", "--mtu=1450"]
      
  before_script:
    - echo "ğŸ” Harborì— ë¡œê·¸ì¸ ì¤‘..."
    - echo "$HARBOR_PASSWORD" | docker login $HARBOR_URL -u $HARBOR_USERNAME --password-stdin
    - docker pull ${IMAGE_NAME}:latest || true
    
  script:
    - echo "ğŸ”¨ MRìš© ì´ë¯¸ì§€ ë¹Œë“œ (Push ì œì™¸)..."
    - |
      docker build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from ${IMAGE_NAME}:latest \
        --tag ${IMAGE_NAME}:mr-${CI_MERGE_REQUEST_IID} \
        --file Dockerfile \
        --progress=plain \
        .
    - echo "âœ… MR ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ (Harbor Push ì•ˆ í•¨)"
    
  after_script:
    - docker logout $HARBOR_URL || true
    
  tags:
    - k8s-runner
    
  only:
    - merge_requests
    
  except:
    - master
    - main
